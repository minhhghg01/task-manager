</main>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="/js/client-app.js"></script>

<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<script> feather.replace(); </script>

<link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet" type="text/css">
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" type="text/javascript"></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    /* Ẩn mũi tên sort mặc định */
    .datatable-sorter::before,
    .datatable-sorter::after {
        display: none !important;
    }

    .datatable-sorter {
        cursor: pointer;
        position: relative;
        user-select: none;
    }

    /* Dark Mode support */
    [data-bs-theme="dark"] .datatable-table {
        color: #fff;
        background-color: #212529;
    }

    [data-bs-theme="dark"] .datatable-pagination a {
        color: #fff;
        background-color: #343a40;
        border-color: #495057;
    }

    [data-bs-theme="dark"] .datatable-input,
    [data-bs-theme="dark"] .datatable-selector {
        background-color: #2b3035;
        color: #fff;
        border-color: #495057;
    }
</style>

<script>
    // --- A. KHỞI TẠO DATATABLE ---
    const tables = document.querySelectorAll(".datatable-init");
    tables.forEach(table => {
        new simpleDatatables.DataTable(table, {
            perPage: 10,
            perPageSelect: [10, 20, 50],
            labels: {
                placeholder: "Tìm kiếm...",
                perPage: "dòng / trang",
                noRows: "Không có dữ liệu",
                info: "Đang hiện {start} đến {end} của {rows} dòng",
            },
            sortable: true,
            fixedHeight: false,
        });
    });

    // --- B. HÀM XÁC NHẬN XÓA (SWEETALERT2) ---
    function confirmDelete(url, title = 'Bạn chắc chắn chứ?') {
        Swal.fire({
            title: title,
            text: "Hành động này không thể hoàn tác!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Vâng, xóa nó!',
            cancelButtonText: 'Hủy bỏ',
            background: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#343a40' : '#fff',
            color: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#fff' : '#000'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = url;
            }
        });
        return false;
    }

    // --- C. LOGIC TỰ ĐỘNG RELOAD KHI ĐỔI QUYỀN (SOCKET.IO) ---
    document.addEventListener("DOMContentLoaded", () => {
        // 1. Kết nối Socket
        const socket = io();

        // 2. Lấy ID user hiện tại từ EJS (được server truyền xuống)
        // Dòng này an toàn: nếu không có user (trang login) thì trả về rỗng
        const currentUserId = '<%= (typeof user !== "undefined" && user) ? user.id : "" %>';

        if (currentUserId) {
            // 3. Lắng nghe sự kiện 'role_changed' từ Server
            socket.on('role_changed', function (data) {

                // Kiểm tra: Nếu ID bị đổi quyền trùng với ID của mình
                if (String(data.userId) === String(currentUserId)) {

                    // Hiện thông báo đẹp bằng Swal
                    Swal.fire({
                        title: 'Thông báo hệ thống',
                        text: data.message,
                        icon: 'info',
                        allowOutsideClick: false, // Bắt buộc phải bấm OK
                        confirmButtonText: 'Đồng ý & Cập nhật'
                    }).then((result) => {
                        // Khi bấm OK -> Reload trang để cập nhật quyền mới
                        if (result.isConfirmed) {
                            window.location.reload();
                        }
                    });
                }
            });
        }
    });
</script>

</body>

</html>