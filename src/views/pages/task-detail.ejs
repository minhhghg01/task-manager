<%- include('../partials/header') %>

    <% /* LOGIC MAU SAC (Color Logic) */ var pColor='secondary' ; if (task.priority=='Cao (Gấp)' ) pColor='danger' ;
        else if (task.priority=='Trung bình' ) pColor='warning text-dark' ; else if (task.priority=='Thấp' )
        pColor='info text-dark' ; var sColor='primary' ; if (task.status=='Mới tạo' ) sColor='info text-dark' ; else if
        (task.status=='Hoàn thành' ) sColor='success' ; else if (task.status=='Quá hạn' ) sColor='danger' ; else if
        (task.status=='Đang chờ' ) sColor='warning text-dark' ; /* LOGIC NGAY THANG (Date Logic) */ var
        startDateString="Chưa cập nhật" ; if (task.start_date) { startDateString=new
        Date(task.start_date).toLocaleString('vi-VN', { hour: '2-digit' , minute: '2-digit' , day: '2-digit' ,
        month: '2-digit' , year: 'numeric' }); } else if (task.createdAt) { startDateString=new
        Date(task.createdAt).toLocaleString('vi-VN', { hour: '2-digit' , minute: '2-digit' , day: '2-digit' ,
        month: '2-digit' , year: 'numeric' }); } %>

        <style>
            /* CSS THANH TIEN DO GOP (Merged Progress Bar) */
            .progress-wrapper {
                position: relative;
                height: 24px;
                background-color: #e9ecef;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
            }

            .progress-visual {
                height: 100%;
                background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #198754 100%);
                /* Red -> Yellow -> Green */
                width: 0%;
                transition: width 0.3s ease;
            }

            .progress-slider {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                opacity: 0;
                /* An di de hien thi visual ben duoi */
                cursor: pointer;
                margin: 0;
            }

            .progress-label {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 12px;
                color: #333;
                text-shadow: 0 0 2px #fff;
                pointer-events: none;
            }
        </style>

        <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
            <a href="javascript:history.back()" class="btn btn-outline-secondary">&larr; Quay lại</a>
            <h4>Chi tiết công việc #<%= task.id %>
            </h4>
        </div>

        <div class="row">
            <div class="col-md-7">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">

                        <div class="mb-3">
                            <span class="badge bg-<%= pColor %> me-1">
                                <%= task.priority %>
                            </span>
                            <span id="statusBadge" class="badge bg-<%= sColor %>">
                                <%= task.status %>
                            </span>
                        </div>

                        <h3 class="card-title text-primary mb-4">
                            <%= task.title %>
                        </h3>

                        <div class="row mb-3 g-2">
                            <div class="col-6">
                                <div class="p-2 border rounded bg-light h-100">
                                    <small class="text-muted d-block"><i data-feather="calendar" style="width:14px"></i>
                                        Ngày bắt đầu:</small>
                                    <strong class="text-primary">
                                        <%= startDateString %>
                                    </strong>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 border rounded bg-light h-100">
                                    <small class="text-muted d-block"><i data-feather="clock" style="width:14px"></i>
                                        Hạn chót:</small>
                                    <strong class="<%= task.status==='Quá hạn'?'text-danger':'' %>">
                                        <%= task.formattedDueDate %>
                                    </strong>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="fw-bold text-muted small">Nội dung:</label>
                            <div class="bg-white p-3 border rounded" style="white-space: pre-wrap; min-height: 80px;">
                                <%= task.description %>
                            </div>
                        </div>

                        <% if(task.attachment_path) { %>
                            <div class="alert alert-info p-2 mb-3 d-flex align-items-center">
                                <span data-feather="paperclip" class="me-2"></span>
                                <a href="<%= task.attachment_path %>" download
                                    class="fw-bold text-decoration-underline">Tải tài liệu đính kèm</a>
                            </div>
                            <% } %>

                                <hr>

                                <div class="row mb-4">
                                    <div class="col-6">
                                        <small class="text-muted">Người giao:</small><br>
                                        <strong>
                                            <%= task.Creator.fullname %>
                                        </strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Người nhận:</small><br>
                                        <strong>
                                            <%= task.assigneeNames %>
                                        </strong>
                                    </div>
                                </div>

                                <div class="card bg-light border-0 p-3 mb-3">
                                    <label class="fw-bold text-primary mb-2">Cập nhật tiến độ:</label>

                                    <form id="progressForm" class="d-flex align-items-center gap-2">
                                        <div class="flex-grow-1 progress-wrapper">
                                            <div class="progress-visual" id="progressVisual"
                                                style="width: <%= task.progress %>%;"></div>
                                            <div class="progress-label"><span id="progVal">
                                                    <%= task.progress %>
                                                </span>%</div>
                                            <input type="range" class="progress-slider" id="progressRange" min="0"
                                                max="100" value="<%= task.progress %>" <%=(isAssignee || isAdmin) ? ''
                                                : 'disabled' %> >
                                        </div>

                                        <% if ((isAssignee || isAdmin) && task.status !=='Quá hạn' ) { %>
                                            <button type="submit" class="btn btn-primary btn-sm"
                                                id="btnUpdateProgress">Lưu</button>
                                            <% } %>
                                    </form>
                                </div>

                                <% if (isAssigner || isAdmin) { %>
                                    <div class="p-3 border rounded bg-white">
                                        <form id="scoreForm" class="d-flex align-items-center gap-2">
                                            <label class="fw-bold text-danger text-nowrap">Chấm điểm:</label>
                                            <input type="number" id="scoreInput" class="form-control"
                                                placeholder="0-100" value="<%= task.score %>" min="0" max="100">
                                            <button class="btn btn-danger btn-sm">Lưu</button>
                                        </form>
                                        <div id="scoreResult" class="mt-2 text-end">
                                            <% if(task.score !==null) { %>
                                                <small class="text-success fw-bold">Đã chấm: <%= task.score %>
                                                        điểm</small>
                                                <% } %>
                                        </div>
                                    </div>
                                    <% } else if (task.score !==null) { %>
                                        <div class="alert alert-success mt-3 text-center p-2">
                                            <strong>Kết quả đánh giá: <%= task.score %>/100 điểm</strong>
                                        </div>
                                        <% } %>

                    </div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white p-0">
                        <ul class="nav nav-tabs nav-fill" id="taskTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active fw-bold" id="comments-tab" data-bs-toggle="tab"
                                    data-bs-target="#comments" type="button" role="tab">Thảo luận</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link fw-bold" id="history-tab" data-bs-toggle="tab"
                                    data-bs-target="#history" type="button" role="tab">Lịch sử</button>
                            </li>
                        </ul>
                    </div>

                    <div class="card-body p-0 d-flex flex-column">
                        <div class="tab-content flex-grow-1 overflow-auto p-3" id="taskTabContent"
                            style="max-height: 600px;">

                            <div class="tab-pane fade show active" id="comments" role="tabpanel">
                                <div id="commentList">
                                    <% if (task.TaskComments && task.TaskComments.length> 0) { %>
                                        <% task.TaskComments.forEach(cmt=> { %>
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between">
                                                    <strong>
                                                        <%= cmt.User ? cmt.User.fullname : 'Ẩn danh' %>
                                                    </strong>
                                                    <small class="text-muted" style="font-size:0.7em">
                                                        <%= new Date(cmt.createdAt).toLocaleString('vi-VN') %>
                                                    </small>
                                                </div>
                                                <div
                                                    class="bg-light p-2 rounded border-start border-3 border-primary text-break">
                                                    <%= cmt.comment %>
                                                </div>
                                            </div>
                                            <% }) %>
                                                <% } else { %>
                                                    <p class="text-center text-muted mt-4" id="noCommentText">Chưa có
                                                        thảo luận.</p>
                                                    <% } %>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="history" role="tabpanel">
                                <ul class="list-group list-group-flush" id="historyList">
                                    <% if (task.history && task.history.length> 0) { %>
                                        <% task.history.forEach(log=> { %>
                                            <li class="list-group-item px-0 py-2">
                                                <div class="d-flex justify-content-between">
                                                    <strong>
                                                        <%= log.User ? log.User.fullname : 'Hệ thống' %>
                                                    </strong>
                                                    <small class="text-muted" style="font-size:0.7em">
                                                        <%= new Date(log.createdAt).toLocaleString('vi-VN') %>
                                                    </small>
                                                </div>
                                                <span class="small fst-italic text-muted">
                                                    <%= log.details %>
                                                </span>
                                            </li>
                                            <% }) %>
                                                <% } else { %>
                                                    <li class="list-group-item text-center text-muted">Chưa có lịch sử
                                                        hoạt động.</li>
                                                    <% } %>
                                </ul>
                            </div>
                        </div>

                        <form id="commentForm" class="mt-auto border-top p-2 bg-light">
                            <div class="input-group">
                                <input type="text" id="commentInput" class="form-control"
                                    placeholder="Viết bình luận..." required autocomplete="off">
                                <button class="btn btn-primary"><i data-feather="send"></i></button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const taskId = '<%= task.id %>';

            // 1. THANH TIEN DO VISUAL (Cap nhat mau khi keo)
            const rangeInput = document.getElementById('progressRange');
            const visualBar = document.getElementById('progressVisual');
            const valDisplay = document.getElementById('progVal');

            if (rangeInput) {
                rangeInput.addEventListener('input', function () {
                    visualBar.style.width = this.value + '%';
                    valDisplay.innerText = this.value;
                });
            }

            // 2. SUBMIT TIEN DO
            const pForm = document.getElementById('progressForm');
            if (pForm) {
                pForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const btn = document.getElementById('btnUpdateProgress');
                    const val = rangeInput.value;

                    btn.textContent = '...'; btn.disabled = true;

                    fetch(`/tasks/${taskId}/progress`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ progress: val })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                location.reload();
                            } else {
                                alert('Lỗi: ' + data.message);
                                btn.disabled = false; btn.textContent = 'Lưu';
                            }
                        });
                });
            }

            // 3. SUBMIT DIEM
            const sForm = document.getElementById('scoreForm');
            if (sForm) sForm.addEventListener('submit', e => {
                e.preventDefault();
                const v = document.getElementById('scoreInput').value;
                fetch(`/tasks/${taskId}/score`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ score: v }) })
                    .then(r => r.json()).then(d => { if (d.success) { alert('Đã chấm điểm!'); location.reload(); } });
            });

            // 4. SUBMIT COMMENT
            const cForm = document.getElementById('commentForm');
            if (cForm) cForm.addEventListener('submit', e => {
                e.preventDefault();
                const inp = document.getElementById('commentInput');
                const v = inp.value.trim();
                if (!v) return;

                fetch(`/tasks/${taskId}/comment`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: v }) })
                    .then(r => r.json()).then(d => {
                        if (d.success) {
                            inp.value = '';
                            const noCmt = document.getElementById('noCommentText');
                            if (noCmt) noCmt.style.display = 'none';

                            const list = document.getElementById('commentList');
                            const div = document.createElement('div');
                            div.className = 'mb-3';
                            div.innerHTML = `<div class="d-flex justify-content-between"><strong>${d.comment.user}</strong><small class="text-muted" style="font-size:0.7em">Vừa xong</small></div><div class="bg-light p-2 rounded border-start border-3 border-primary text-break">${d.comment.content}</div>`;
                            list.appendChild(div);

                            const container = document.getElementById('taskTabContent');
                            container.scrollTop = container.scrollHeight;
                        }
                    });
            });
        </script>

        <%- include('../partials/footer') %>