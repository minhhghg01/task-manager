<%- include('../partials/header') %>

    <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
        <a href="javascript:history.back()" class="btn btn-outline-secondary">&larr; Quay lại</a>
        <h4>Chi tiết công việc #<%= task.id %>
        </h4>
    </div>

    <div class="row">
        <div class="col-md-7">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h3 class="card-title text-primary">
                        <%= task.title %>
                    </h3>
                    <div class="mb-3">
                        <span class="badge bg-secondary">
                            <%= task.priority %>
                        </span>
                        <span id="statusBadge"
                            class="badge bg-<%= task.status==='Completed'?'success':(task.status==='Overdue'?'danger':'primary') %>">
                            <%= task.status %>
                        </span>
                        <span class="text-muted ms-2">Hạn: <%= task.formattedDueDate %></span>
                    </div>

                    <p class="card-text bg-light p-3 rounded" style="white-space: pre-wrap;">
                        <%= task.description %>
                    </p>

                    <% if(task.attachment_path) { %>
                        <div class="alert alert-info d-flex align-items-center">
                            <span data-feather="paperclip" class="me-2"></span>
                            <div>
                                <strong>Tài liệu đính kèm:</strong><br>
                                <a href="<%= task.attachment_path %>" download
                                    class="text-decoration-underline fw-bold">
                                    Tải xuống tài liệu
                                </a>
                            </div>
                        </div>
                        <% } %>

                            <hr>
                            <div class="row">
                                <div class="col-6">
                                    <strong>Người giao:</strong>
                                    <%= task.Creator.fullname %><br>
                                        <strong>Người nhận:</strong>
                                        <%= task.assigneeNames %>
                                </div>
                                <div class="col-6 text-end">
                                    <div class="display-6 fw-bold text-primary" id="progressDisplay">
                                        <%= task.progress %>%
                                    </div>
                                    <small>Tiến độ hiện tại</small>
                                </div>
                            </div>

                            <% if (isAssignee || isAdmin) { %>
                                <hr>
                                <form id="progressForm" class="mt-3">
                                    <label class="form-label fw-bold">Cập nhật tiến độ:</label>
                                    <div class="d-flex align-items-center">
                                        <input type="range" class="form-range flex-grow-1 me-3" id="progressRange"
                                            min="0" max="100" value="<%= task.progress %>"
                                            oninput="document.getElementById('progressOutput').value = this.value">
                                        <output id="progressOutput" class="fw-bold fs-5">
                                            <%= task.progress %>
                                        </output>%
                                    </div>
                                    <button type="submit" class="btn btn-primary mt-2" id="btnUpdateProgress">Cập
                                        nhật</button>
                                </form>
                                <% } %>

                                    <% if (isAssigner || isAdmin) { %>
                                        <hr>
                                        <form id="scoreForm" class="mt-3 bg-light p-3 rounded border">
                                            <label class="form-label fw-bold text-danger">Đánh giá / Chấm điểm:</label>
                                            <div class="input-group mb-2">
                                                <input type="number" id="scoreInput" class="form-control"
                                                    placeholder="Nhập điểm (0-100)" value="<%= task.score %>" min="0"
                                                    max="100" required>
                                                <span class="input-group-text">/ 100</span>
                                                <button class="btn btn-danger" type="submit">Lưu điểm</button>
                                            </div>
                                            <div id="scoreResult">
                                                <% if(task.score !==null) { %>
                                                    <small class="text-success">Đã chấm: <strong>
                                                            <%= task.score %> điểm
                                                        </strong></small>
                                                    <% } %>
                                            </div>
                                        </form>
                                        <% } else if (task.score !==null) { %>
                                            <div class="alert alert-success mt-3">
                                                <strong>Kết quả đánh giá:</strong>
                                                <%= task.score %>/100 điểm
                                            </div>
                                            <% } %>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white p-0">
                    <ul class="nav nav-tabs nav-fill" id="taskTab" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="comments-tab" data-bs-toggle="tab"
                                data-bs-target="#comments" type="button">Thảo luận</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history"
                                type="button">Lịch sử</button>
                        </li>
                    </ul>
                </div>

                <div class="card-body d-flex flex-column p-0">
                    <div class="tab-content flex-grow-1 overflow-auto p-3" id="taskTabContent"
                        style="max-height: 500px;">

                        <div class="tab-pane fade show active" id="comments">
                            <div id="commentList">
                                <% if (task.TaskComments && task.TaskComments.length> 0) { %>
                                    <% task.TaskComments.forEach(cmt=> { %>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between">
                                                <strong>
                                                    <%= cmt.User ? cmt.User.fullname : 'Ẩn danh' %>
                                                </strong>
                                                <small class="text-muted" style="font-size:0.8em">
                                                    <%= new Date(cmt.createdAt).toLocaleString('vi-VN') %>
                                                </small>
                                            </div>
                                            <div class="bg-light p-2 rounded border-start border-3 border-primary">
                                                <%= cmt.comment %>
                                            </div>
                                        </div>
                                        <% }) %>
                                            <% } else { %>
                                                <p class="text-muted text-center mt-4" id="noCommentText">Chưa có bình
                                                    luận nào.</p>
                                                <% } %>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="history">
                            <ul class="list-group list-group-flush" id="historyList">
                                <% if (task.history && task.history.length> 0) { %>
                                    <% task.history.forEach(log=> { %>
                                        <li class="list-group-item px-0">
                                            <div class="d-flex justify-content-between">
                                                <strong>
                                                    <%= log.User ? log.User.fullname : 'Hệ thống' %>
                                                </strong>
                                                <small class="text-muted" style="font-size:0.8em">
                                                    <%= new Date(log.createdAt).toLocaleString('vi-VN') %>
                                                </small>
                                            </div>
                                            <span class="text-muted small fst-italic">
                                                <%= log.details %>
                                            </span>
                                        </li>
                                        <% }) %>
                                            <% } %>
                            </ul>
                        </div>
                    </div>

                    <form id="commentForm" class="mt-auto border-top p-3 bg-light">
                        <div class="input-group">
                            <input type="text" id="commentInput" class="form-control" placeholder="Viết bình luận..."
                                required autocomplete="off">
                            <button class="btn btn-primary" type="submit"><span data-feather="send"></span></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const taskId = '<%= task.id %>';

        // 1. XỬ LÝ UPDATE PROGRESS (AJAX)
        const progressForm = document.getElementById('progressForm');
        if (progressForm) {
            progressForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const btn = document.getElementById('btnUpdateProgress');
                const val = document.getElementById('progressRange').value;

                btn.disabled = true;
                btn.textContent = 'Đang lưu...';

                fetch(`/tasks/${taskId}/progress`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ progress: val })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            // Update UI ngay lập tức
                            document.getElementById('progressDisplay').innerText = val + '%';
                            const badge = document.getElementById('statusBadge');
                            badge.innerText = data.status;

                            // Đổi màu badge
                            badge.className = `badge bg-${data.status === 'Completed' ? 'success' : (data.status === 'Overdue' ? 'danger' : 'primary')}`;

                            // Thêm log vào tab lịch sử (giả lập)
                            const historyList = document.getElementById('historyList');
                            const li = document.createElement('li');
                            li.className = 'list-group-item px-0';
                            li.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <strong>Bạn</strong>
                            <small class="text-muted" style="font-size:0.8em">Vừa xong</small>
                        </div>
                        <span class="text-muted small fst-italic">Cập nhật tiến độ: ${val}% (Trạng thái: ${data.status})</span>
                    `;
                            historyList.prepend(li);
                        }
                        btn.disabled = false;
                        btn.textContent = 'Cập nhật';
                    });
            });
        }

        // 2. XỬ LÝ GỬI COMMENT (AJAX)
        const commentForm = document.getElementById('commentForm');
        if (commentForm) {
            commentForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const input = document.getElementById('commentInput');
                const content = input.value.trim();
                if (!content) return;

                fetch(`/tasks/${taskId}/comment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            input.value = ''; // Xóa ô nhập

                            // Ẩn dòng "chưa có comment"
                            const noCmt = document.getElementById('noCommentText');
                            if (noCmt) noCmt.style.display = 'none';

                            // Thêm comment mới vào list
                            const list = document.getElementById('commentList');
                            const div = document.createElement('div');
                            div.className = 'mb-3';
                            div.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <strong>${data.comment.user}</strong>
                            <small class="text-muted" style="font-size:0.8em">Vừa xong</small>
                        </div>
                        <div class="bg-light p-2 rounded border-start border-3 border-primary">
                            ${data.comment.content}
                        </div>
                    `;
                            list.appendChild(div);

                            // Scroll xuống dưới cùng
                            const container = document.getElementById('taskTabContent');
                            container.scrollTop = container.scrollHeight;
                        }
                    });
            });
        }

        // 3. XỬ LÝ CHẤM ĐIỂM (AJAX)
        const scoreForm = document.getElementById('scoreForm');
        if (scoreForm) {
            scoreForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const val = document.getElementById('scoreInput').value;

                fetch(`/tasks/${taskId}/score`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ score: val })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('scoreResult').innerHTML =
                                `<small class="text-success">Đã chấm: <strong>${val} điểm</strong></small>`;
                            alert('Đã lưu điểm thành công!');
                        }
                    });
            });
        }
    </script>

    <%- include('../partials/footer') %>