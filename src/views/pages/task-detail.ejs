<%- include('../partials/header') %>

    <% /* --- 1. XỬ LÝ MÀU SẮC --- */ const pMap={ 'Cao (Gấp)' : 'danger' , 'Trung bình' : 'warning text-dark' , 'Thấp'
        : 'info text-dark' }; const pColor=pMap[task.priority] || 'secondary' ; const sMap={ 'Mới tạo'
        : 'info text-dark' , 'Hoàn thành' : 'success' , 'Quá hạn' : 'danger' , 'Đang chờ' : 'warning text-dark'
        , 'Đang thực hiện' : 'primary' }; const sColor=sMap[task.status] || 'secondary' ; /* --- 2. XỬ LÝ NGÀY THÁNG ---
        */ let displayStartDate="Chưa cập nhật" ; if (task.formattedStartDate) {
        displayStartDate=task.formattedStartDate; } else { const d=task.start_date || task.createdAt; if (d) {
        displayStartDate=new Date(d).toLocaleString('vi-VN', { hour: '2-digit' , minute: '2-digit' , day: '2-digit' ,
        month: '2-digit' , year: 'numeric' }); } } %>

        <style>
            /* CSS THANH TIẾN ĐỘ & TAB */
            .progress-container {
                position: relative;
                height: 28px;
                background-color: #e9ecef;
                border-radius: 14px;
                overflow: hidden;
                box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
            }

            .progress-fill {
                height: 100%;
                width: 0%;
                background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #198754 100%);
                transition: width 0.3s ease;
                border-radius: 14px;
            }

            .progress-input {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                opacity: 0;
                cursor: pointer;
                margin: 0;
                z-index: 10;
            }

            .progress-text {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 13px;
                color: #333;
                text-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
                pointer-events: none;
                z-index: 5;
            }

            .nav-tabs .nav-link.active {
                border-bottom: 3px solid #0d6efd;
                color: #0d6efd;
                font-weight: bold;
                background: #fff;
            }

            .nav-tabs .nav-link {
                color: #6c757d;
                border: none;
                background: #f8f9fa;
                margin-right: 2px;
                cursor: pointer;
            }

            .todo-done {
                text-decoration: line-through;
                color: #adb5bd;
            }

            .form-check-input:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }
        </style>

        <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
            <div class="d-flex align-items-center gap-3">
                <a href="javascript:history.back()" class="btn btn-outline-secondary">&larr; Quay lại</a>
                <h4 class="mb-0">Chi tiết công việc #<%= task.id %>
                </h4>
            </div>

            <% if (isAdmin || isAssigner) { %>
                <button type="button" class="btn btn-outline-primary d-flex align-items-center gap-2"
                    data-bs-toggle="modal" data-bs-target="#editTaskModal">
                    <span data-feather="edit-2" style="width: 16px; height: 16px;"></span> Sửa công việc
                </button>
                <% } %>
        </div>

        <div class="row">
            <div class="col-md-7">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="mb-3">
                            <span class="badge bg-<%= pColor %> me-1">
                                <%= task.priority %>
                            </span>
                            <span id="statusBadge" class="badge bg-<%= sColor %> me-1">
                                <%= task.status %>
                            </span>

                            <% if (task.tags && task.tags.trim() !=='' ) { %>
                                <% task.tags.split(',').forEach(tag=> { %>
                                    <span class="badge border border-info text-info me-1">
                                        <i data-feather="tag" style="width: 10px; height: 10px;"></i>
                                        <%= tag.trim() %>
                                    </span>
                                    <% }) %>
                                        <% } %>
                        </div>

                        <h3 class="card-title text-primary mb-4">
                            <%= task.title %>
                        </h3>

                        <div class="row mb-3 g-2">
                            <div class="col-6">
                                <div class="p-2 border rounded bg-light h-100">
                                    <small class="text-muted d-block"><i data-feather="calendar" style="width:14px"></i>
                                        Ngày bắt đầu:</small>
                                    <strong class="text-primary">
                                        <%= displayStartDate %>
                                    </strong>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 border rounded bg-light h-100">
                                    <small class="text-muted d-block"><i data-feather="clock" style="width:14px"></i>
                                        Hạn chót:</small>
                                    <strong class="<%= task.status==='Quá hạn'?'text-danger':'' %>">
                                        <%= task.formattedDueDate %>
                                    </strong>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="fw-bold text-muted small">Nội dung:</label>
                            <div class="bg-white p-3 border rounded text-break" style="min-height: 80px;">
                                <%= task.description ? task.description.trim() : 'Không có mô tả' %>
                            </div>
                        </div>

                        <% if(task.attachment_path) { %>
                            <div class="alert alert-info p-2 mb-3 d-flex align-items-center">
                                <span data-feather="paperclip" class="me-2"></span>
                                <a href="<%= task.attachment_path %>" download
                                    class="fw-bold text-decoration-underline">Tải tài liệu đính kèm</a>
                            </div>
                            <% } %>

                                <hr>
                                <div class="row mb-4">
                                    <div class="col-6"><small class="text-muted">Người giao:</small><br><strong>
                                            <%= task.Creator ? task.Creator.fullname : 'N/A' %>
                                        </strong></div>
                                    <div class="col-6"><small class="text-muted">Người nhận:</small><br><strong>
                                            <%= task.assigneeNames %>
                                        </strong></div>
                                </div>

                                <div class="card bg-light border-0 p-3 mb-3">
                                    <div class="d-flex justify-content-between mb-2"><label
                                            class="fw-bold text-primary">Cập nhật tiến độ:</label></div>
                                    <form id="progressForm" class="d-flex align-items-center gap-3">
                                        <div class="flex-grow-1 progress-container">
                                            <div class="progress-fill" id="progressVisual"
                                                style="width: <%= task.progress %>%;"></div>
                                            <div class="progress-text"><span id="progVal">
                                                    <%= task.progress %>
                                                </span>%</div>
                                            <input type="range" class="progress-input" id="progressRange" min="0"
                                                max="100" value="<%= task.progress %>" <%=(typeof isAssignee
                                                !=='undefined' && isAssignee) || (typeof isAdmin !=='undefined' &&
                                                isAdmin) ? '' : 'disabled' %>>
                                        </div>
                                        <% if ((typeof isAssignee !=='undefined' && isAssignee) || (typeof isAdmin
                                            !=='undefined' && isAdmin)) { %>
                                            <% if(task.status !=='Quá hạn' ) { %>
                                                <button type="submit" class="btn btn-primary fw-bold px-3"
                                                    id="btnUpdateProgress">Lưu</button>
                                                <% } %>
                                                    <% } %>
                                    </form>
                                </div>

                                <% if (typeof canScore !=='undefined' && canScore) { %>
                                    <div class="p-3 border rounded bg-white">
                                        <form id="scoreForm" class="d-flex align-items-center gap-2">
                                            <label class="fw-bold text-danger text-nowrap">Chấm điểm:</label>
                                            <input type="number" id="scoreInput" class="form-control"
                                                placeholder="0-100" value="<%= task.score %>" min="0" max="100">
                                            <button class="btn btn-danger btn-sm">Lưu</button>
                                        </form>
                                        <div id="scoreResult" class="mt-2 text-end">
                                            <% if(task.score !==null) { %>
                                                <small class="text-success fw-bold">Đã chấm: <%= task.score %>
                                                        điểm</small>
                                                <% } %>
                                        </div>
                                    </div>
                                    <% } else if (task.score !==null) { %>
                                        <div class="alert alert-success mt-3 text-center p-2">
                                            <strong>Kết quả đánh giá: <%= task.score %>/100 điểm</strong>
                                        </div>
                                        <% } %>
                    </div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-light p-0">
                        <ul class="nav nav-tabs nav-fill" id="taskTab" role="tablist">
                            <li class="nav-item"><button class="nav-link active fw-bold" id="collab-tab"
                                    data-bs-toggle="tab" data-bs-target="#collab" type="button">Việc & Người</button>
                            </li>
                            <li class="nav-item"><button class="nav-link fw-bold" id="comments-tab" data-bs-toggle="tab"
                                    data-bs-target="#comments" type="button">Thảo luận</button></li>
                            <li class="nav-item"><button class="nav-link fw-bold" id="history-tab" data-bs-toggle="tab"
                                    data-bs-target="#history" type="button">Lịch sử</button></li>
                        </ul>
                    </div>

                    <div class="card-body p-0 d-flex flex-column">
                        <div class="tab-content flex-grow-1 overflow-auto p-3" id="taskTabContent"
                            style="max-height: 600px;">

                            <div class="tab-pane fade show active" id="collab" role="tabpanel">
                                <% const canEditTodo=(typeof isAssignee !=='undefined' && isAssignee) || (typeof
                                    isAssigner !=='undefined' && isAssigner) || (typeof isAdmin !=='undefined' &&
                                    isAdmin); %>
                                    <div class="mb-4">
                                        <h6 class="fw-bold text-primary border-bottom pb-2">Checklist công việc</h6>
                                        <div class="list-group list-group-flush mb-2" id="todoList">
                                            <% if (task.parsedTodoList && task.parsedTodoList.length> 0) { %>
                                                <% task.parsedTodoList.forEach(item=> { %>
                                                    <label
                                                        class="list-group-item d-flex gap-2 align-items-center bg-transparent px-0 py-1 border-0">
                                                        <input class="form-check-input flex-shrink-0 todo-check"
                                                            type="checkbox" value="<%= item.id %>" <%=item.done
                                                            ? 'checked' : '' %>
                                                        <%= canEditTodo ? '' : 'disabled' %>>
                                                            <span class="<%= item.done ? 'todo-done' : '' %>">
                                                                <%= item.text %>
                                                            </span>
                                                    </label>
                                                    <% }) %>
                                                        <% } else { %>
                                                            <small class="text-muted fst-italic">Chưa có đầu việc
                                                                nào.</small>
                                                            <% } %>
                                        </div>

                                        <% if (canEditTodo) { %>
                                            <div class="input-group input-group-sm">
                                                <input type="text" id="newTodoInput" class="form-control"
                                                    placeholder="Thêm đầu việc...">
                                                <button class="btn btn-outline-primary" id="btnAddTodo"><i
                                                        data-feather="plus"></i></button>
                                            </div>
                                            <% } %>
                                    </div>

                                    <hr>

                                    <div>
                                        <div
                                            class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                                            <h6 class="fw-bold text-success mb-0">Người phối hợp</h6>
                                            <% if (canEditTodo) { %>
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-outline-success py-0" type="button"
                                                        data-bs-toggle="dropdown">+ Mời thêm</button>
                                                    <ul class="dropdown-menu p-2"
                                                        style="width: 250px; max-height: 200px; overflow-y: auto;">
                                                        <input type="text" class="form-control form-control-sm mb-2"
                                                            placeholder="Tìm tên..." onkeyup="filterUsers(this)">
                                                        <div id="userDropdown">
                                                            <% if (typeof allUsers !=='undefined' && allUsers.length> 0)
                                                                { %>
                                                                <% allUsers.forEach(u=> {
                                                                    let exist = (u.id == task.assigned_by) ||
                                                                    (task.assigneeList && task.assigneeList.some(a =>
                                                                    a.id == u.id)) ||
                                                                    (task.collaboratorList &&
                                                                    task.collaboratorList.some(c => c.id == u.id));
                                                                    if (!exist) { %>
                                                                    <li><button class="dropdown-item"
                                                                            onclick="inviteCollab(<%= u.id %>)">
                                                                            <%= u.fullname %>
                                                                        </button></li>
                                                                    <% } }) %>
                                                                        <% } %>
                                                        </div>
                                                    </ul>
                                                </div>
                                                <% } %>
                                        </div>

                                        <div class="list-group list-group-flush">
                                            <% if (task.collaboratorList && task.collaboratorList.length> 0) { %>
                                                <% task.collaboratorList.forEach(c=> { %>
                                                    <div
                                                        class="list-group-item px-0 py-2 d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <span class="fw-bold">
                                                                <%= c.fullname %>
                                                            </span>
                                                            <% if (c.status==='ACCEPTED' ) { %>
                                                                <span
                                                                    class="badge bg-success-subtle text-success border border-success"
                                                                    style="font-size: 0.7em;">Đã tham gia</span>
                                                                <% } else { %>
                                                                    <span
                                                                        class="badge bg-warning-subtle text-warning border border-warning"
                                                                        style="font-size: 0.7em;">Chờ đồng ý</span>
                                                                    <% } %>
                                                        </div>

                                                        <% if (typeof user !=='undefined' &&
                                                            String(c.id)===String(user.id)) { %>
                                                            <div>
                                                                <% if (c.status==='PENDING' ) { %>
                                                                    <button class="btn btn-sm btn-success py-0"
                                                                        onclick="respondCollab('ACCEPT')"
                                                                        title="Đồng ý"><i
                                                                            data-feather="check"></i></button>
                                                                    <button class="btn btn-sm btn-outline-danger py-0"
                                                                        onclick="respondCollab('DECLINE')"
                                                                        title="Từ chối"><i
                                                                            data-feather="x"></i></button>
                                                                    <% } else if (c.status==='ACCEPTED' ) { %>
                                                                        <button
                                                                            class="btn btn-sm btn-outline-secondary py-0"
                                                                            onclick="respondCollab('REMOVE')"
                                                                            title="Rời khỏi"><i
                                                                                data-feather="log-out"></i></button>
                                                                        <% } %>
                                                            </div>
                                                            <% } %>
                                                    </div>
                                                    <% }) %>
                                                        <% } else { %>
                                                            <small class="text-muted">Chưa có người phối hợp.</small>
                                                            <% } %>
                                        </div>
                                    </div>
                            </div>

                            <div class="tab-pane fade" id="comments" role="tabpanel">
                                <div id="commentList">
                                    <% if (task.TaskComments && task.TaskComments.length> 0) { %>
                                        <% task.TaskComments.forEach(cmt=> { %>
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between">
                                                    <strong>
                                                        <%= cmt.User ? cmt.User.fullname : 'Ẩn danh' %>
                                                    </strong>
                                                    <small class="text-muted" style="font-size:0.7em">
                                                        <%= new Date(cmt.createdAt).toLocaleString('vi-VN') %>
                                                    </small>
                                                </div>
                                                <div
                                                    class="bg-light p-2 rounded border-start border-3 border-primary text-break">
                                                    <%= cmt.comment %>
                                                </div>
                                            </div>
                                            <% }) %>
                                                <% } else { %>
                                                    <p class="text-center text-muted mt-4" id="noCommentText">Chưa có
                                                        thảo luận.</p>
                                                    <% } %>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="history" role="tabpanel">
                                <ul class="list-group list-group-flush" id="historyList">
                                    <% if (task.history && task.history.length> 0) { %>
                                        <% task.history.forEach(log=> { %>
                                            <li class="list-group-item px-0 py-2">
                                                <div class="d-flex justify-content-between">
                                                    <strong>
                                                        <%= log.User ? log.User.fullname : 'Hệ thống' %>
                                                    </strong>
                                                    <small class="text-muted" style="font-size:0.7em">
                                                        <%= new Date(log.createdAt).toLocaleString('vi-VN') %>
                                                    </small>
                                                </div>
                                                <span class="small fst-italic text-muted">
                                                    <%= log.details %>
                                                </span>
                                            </li>
                                            <% }) %>
                                                <% } else { %>
                                                    <li class="list-group-item text-center text-muted border-0">Chưa có
                                                        lịch sử.</li>
                                                    <% } %>
                                </ul>
                            </div>
                        </div>

                        <form id="commentForm" class="mt-auto border-top p-2 bg-light">
                            <div class="input-group">
                                <input type="text" id="commentInput" class="form-control"
                                    placeholder="Viết bình luận..." required autocomplete="off">
                                <button class="btn btn-primary"><i data-feather="send"></i></button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <% if (isAdmin || isAssigner) { %>
            <div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content border-0 shadow">
                        <div class="modal-header bg-light">
                            <h5 class="modal-title fw-bold text-primary">Sửa thông tin công việc</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editTaskForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label class="form-label fw-bold small">Tiêu đề công việc <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="title" id="editTitle"
                                        value="<%= task.title %>" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold small">Mô tả chi tiết</label>
                                    <textarea class="form-control" name="description" id="editDescription"
                                        rows="4"><%= task.description || '' %></textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold small">Hạn chót (Tùy chọn)</label>
                                        <% let formattedEditDate='' ; if (task.due_date) { let d=new
                                            Date(task.due_date); d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                                            formattedEditDate=d.toISOString().slice(0, 16); } %>
                                            <input type="datetime-local" class="form-control" name="due_date"
                                                id="editDueDate" value="<%= formattedEditDate %>">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold small">Mức độ ưu tiên</label>
                                        <select class="form-select" name="priority" id="editPriority">
                                            <option value="Bình thường" <%=task.priority==='Bình thường' ? 'selected'
                                                : '' %>>Bình thường</option>
                                            <option value="Trung bình" <%=task.priority==='Trung bình' ? 'selected' : ''
                                                %>>Trung bình</option>
                                            <option value="Cao (Gấp)" <%=task.priority==='Cao (Gấp)' ? 'selected' : ''
                                                %>>Cao (Gấp)</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold small">Cập nhật File đính kèm mới (Tùy
                                        chọn)</label>
                                    <% if(task.attachment_path) { %>
                                        <div class="small text-muted mb-2">File hiện tại: <a
                                                href="<%= task.attachment_path %>" target="_blank">Xem file</a> (Tải
                                            file mới lên sẽ ghi đè file này)</div>
                                        <% } %>
                                            <input type="file" class="form-control" name="attachment"
                                                id="editAttachment">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer bg-light">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="button" class="btn btn-primary" id="btnSubmitEditTask">Lưu thay đổi</button>
                        </div>
                    </div>
                </div>
            </div>
            <% } %>

                <script>
                    const taskId = '<%= task.id %>';

                    // Xử lý Progress Bar
                    const rangeInput = document.getElementById('progressRange');
                    const visualBar = document.getElementById('progressVisual');
                    const valDisplay = document.getElementById('progVal');
                    if (rangeInput) {
                        rangeInput.addEventListener('input', function () { visualBar.style.width = this.value + '%'; valDisplay.innerText = this.value; });
                    }
                    const pForm = document.getElementById('progressForm');
                    if (pForm) {
                        pForm.addEventListener('submit', function (e) {
                            e.preventDefault();
                            const btn = document.getElementById('btnUpdateProgress');
                            if (btn) {
                                btn.textContent = '...'; btn.disabled = true;
                                fetch(`/tasks/${taskId}/progress`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ progress: rangeInput.value }) })
                                    .then(r => r.json()).then(d => { if (d.success) location.reload(); else { alert('Lỗi: ' + d.message); btn.disabled = false; btn.textContent = 'Lưu'; } });
                            }
                        });
                    }

                    // Xử lý Todos
                    const btnAddTodo = document.getElementById('btnAddTodo');
                    if (btnAddTodo) {
                        btnAddTodo.addEventListener('click', function () {
                            const input = document.getElementById('newTodoInput');
                            if (!input.value.trim()) return;
                            fetch(`/tasks/${taskId}/todos`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'ADD', text: input.value.trim() }) })
                                .then(r => r.json()).then(d => { if (d.success) location.reload(); else alert('Lỗi: ' + d.message || 'Không thể thêm'); });
                        });
                    }
                    document.querySelectorAll('.todo-check').forEach(chk => {
                        chk.addEventListener('change', function () {
                            fetch(`/tasks/${taskId}/todos`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'TOGGLE', todoId: this.value }) })
                                .then(r => r.json()).then(d => {
                                    if (!d.success) {
                                        alert(d.message);
                                        this.checked = !this.checked;
                                    } else {
                                        const span = this.nextElementSibling;
                                        if (this.checked) span.classList.add('todo-done'); else span.classList.remove('todo-done');
                                    }
                                });
                        });
                    });

                    // Xử lý Collaborators
                    function inviteCollab(uid) {
                        if (!confirm('Mời nhân viên này?')) return;
                        fetch(`/tasks/${taskId}/collaborators`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ targetUserId: uid }) })
                            .then(r => r.json()).then(d => { if (d.success) location.reload(); else alert(d.message); });
                    }
                    function respondCollab(action) {
                        let msg = action === 'ACCEPT' ? 'Xác nhận tham gia?' : (action === 'REMOVE' ? 'Rời khỏi công việc?' : 'Từ chối tham gia?');
                        if (!confirm(msg)) return;
                        fetch(`/tasks/${taskId}/collaborators/respond`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: action }) })
                            .then(r => r.json()).then(d => { if (d.success) location.reload(); else alert(d.message); });
                    }
                    function filterUsers(input) {
                        const filter = input.value.toUpperCase();
                        const div = document.getElementById("userDropdown");
                        if (!div) return;
                        const li = div.getElementsByTagName("li");
                        for (let i = 0; i < li.length; i++) {
                            const txt = li[i].textContent || li[i].innerText;
                            if (txt.toUpperCase().indexOf(filter) > -1) li[i].style.display = ""; else li[i].style.display = "none";
                        }
                    }

                    // Xử lý Điểm và Comment
                    const sForm = document.getElementById('scoreForm');
                    if (sForm) sForm.addEventListener('submit', e => {
                        e.preventDefault();
                        fetch(`/tasks/${taskId}/score`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ score: document.getElementById('scoreInput').value }) })
                            .then(r => r.json()).then(d => { if (d.success) { alert('Đã chấm điểm!'); location.reload(); } });
                    });
                    const cForm = document.getElementById('commentForm');
                    if (cForm) cForm.addEventListener('submit', e => {
                        e.preventDefault();
                        const inp = document.getElementById('commentInput');
                        if (!inp.value.trim()) return;
                        fetch(`/tasks/${taskId}/comment`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: inp.value }) })
                            .then(r => r.json()).then(d => { if (d.success) location.reload(); });
                    });

                    // Giữ trạng thái Tab
                    document.addEventListener("DOMContentLoaded", function () {
                        var activeTab = localStorage.getItem('activeTaskTab');
                        if (activeTab) {
                            var tabTrigger = document.querySelector(`button[data-bs-target="${activeTab}"]`);
                            if (tabTrigger) {
                                var tab = new bootstrap.Tab(tabTrigger);
                                tab.show();
                            }
                        }
                        var tabEl = document.querySelectorAll('button[data-bs-toggle="tab"]');
                        tabEl.forEach(function (el) {
                            el.addEventListener('shown.bs.tab', function (event) {
                                localStorage.setItem('activeTaskTab', event.target.getAttribute('data-bs-target'));
                            });
                        });

                        // [MỚI] Gọi API sửa task
                        const btnSubmitEdit = document.getElementById('btnSubmitEditTask');
                        if (btnSubmitEdit) {
                            btnSubmitEdit.addEventListener('click', async function () {
                                const form = document.getElementById('editTaskForm');
                                if (!document.getElementById('editTitle').value.trim()) {
                                    alert('Vui lòng nhập tiêu đề công việc!');
                                    return;
                                }
                                const formData = new FormData(form);
                                btnSubmitEdit.disabled = true;
                                btnSubmitEdit.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang lưu...';
                                try {
                                    const response = await fetch(`/api/tasks/${taskId}/edit`, {
                                        method: 'POST',
                                        body: formData
                                    });
                                    const result = await response.json();
                                    if (result.success) {
                                        alert(result.message);
                                        window.location.reload();
                                    } else {
                                        alert('Lỗi: ' + result.message);
                                        btnSubmitEdit.disabled = false;
                                        btnSubmitEdit.innerText = 'Lưu thay đổi';
                                    }
                                } catch (error) {
                                    console.error('Error:', error);
                                    alert('Lỗi kết nối máy chủ!');
                                    btnSubmitEdit.disabled = false;
                                    btnSubmitEdit.innerText = 'Lưu thay đổi';
                                }
                            });
                        }
                    });
                </script>

                <%- include('../partials/footer') %>