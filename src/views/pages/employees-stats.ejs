<%- include('../partials/header') %>

    <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Thống kê Nhân viên</h1>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle shadow-sm border datatable-init">
            <thead class="table-light">
                <tr>
                    <th>STT</th>
                    <th>Họ tên</th>
                    <th>Chức vụ</th>
                    <th class="text-center">Tổng việc</th>
                    <th class="text-center text-primary">Đang làm</th>
                    <th class="text-center text-success">Đã xong</th>
                    <th class="text-center text-danger">Quá hạn</th>
                    <th class="text-center">Điểm TB</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                <% if (typeof users !=='undefined' && users.length> 0) { %>
                    <% users.forEach((u, index)=> { %>
                        <tr style="cursor: pointer;" onclick="window.location.href='/employees/<%= u.id %>/tasks'">

                            <td>
                                <%= index + 1 %>
                            </td>

                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary text-white rounded-circle d-flex justify-content-center align-items-center me-2"
                                        style="width: 35px; height: 35px;">
                                        <%= u.fullname.charAt(0).toUpperCase() %>
                                    </div>
                                    <div>
                                        <strong>
                                            <%= u.fullname %>
                                        </strong><br>
                                        <small class="text-muted">
                                            <%= u.Department ? u.Department.name : '' %>
                                        </small>
                                    </div>
                                </div>
                            </td>

                            <td>
                                <% var roleName='Nhân viên' ; var roleClass='secondary' ; if (u.role==='DIRECTOR' ) {
                                    roleName='Giám đốc' ; roleClass='danger' ; } else if (u.role==='DEPUTY_DIRECTOR' ) {
                                    roleName='Phó Giám đốc' ; roleClass='danger' ; } else if (u.role==='HEAD' ) {
                                    roleName='Trưởng khoa' ; roleClass='warning text-dark' ; } else if
                                    (u.role==='DEPUTY' ) { roleName='Phó khoa' ; roleClass='info text-dark' ; } else if
                                    (u.role==='LEADER' ) { roleName='Tổ trưởng' ; roleClass='primary' ; } %>
                                    <span class="badge bg-<%= roleClass %>">
                                        <%= roleName %>
                                    </span>
                            </td>

                            <td class="text-center fw-bold fs-5">
                                <%= u.stats.total %>
                            </td>
                            <td class="text-center fw-bold fs-5 text-primary">
                                <%= u.stats.inProgress %>
                            </td>
                            <td class="text-center fw-bold fs-5 text-success">
                                <%= u.stats.completed %>
                            </td>
                            <td class="text-center fw-bold fs-5 text-danger">
                                <%= u.stats.overdue %>
                            </td>

                            <td class="text-center">
                                <% if (u.stats.avgScore) { %>
                                    <% let scoreColor='secondary' ; const score=parseFloat(u.stats.avgScore); if(score>=
                                        80) scoreColor = 'success'; // Giỏi
                                        else if(score >= 50) scoreColor = 'warning text-dark'; // Khá
                                        else scoreColor = 'danger'; // Yếu
                                        %>
                                        <span
                                            class="badge bg-<%= scoreColor %> rounded-pill border border-<%= scoreColor %>"
                                            style="font-size: 0.9rem;">
                                            <%= u.stats.avgScore %>
                                        </span>
                                        <% } else { %>
                                            <span class="text-muted small fst-italic">---</span>
                                            <% } %>
                            </td>

                            <td onclick="event.stopPropagation()">
                                <% if (typeof currentUserRole !=='undefined' && currentUserRole==='HEAD' ) { %>
                                    <% if (u.role==='STAFF' ) { %>
                                        <button onclick="setLeaderRole('<%= u.id %>', 'promote')"
                                            class="btn btn-sm btn-outline-warning text-dark">
                                            <span data-feather="chevrons-up"></span> Lên Tổ trưởng
                                        </button>
                                        <% } else if (u.role==='LEADER' ) { %>
                                            <button onclick="setLeaderRole('<%= u.id %>', 'demote')"
                                                class="btn btn-sm btn-outline-secondary">
                                                <span data-feather="chevrons-down"></span> Xuống NV
                                            </button>
                                            <% } %>
                                                <% } %>
                            </td>
                        </tr>
                        <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="9" class="text-center py-4 text-muted">Không tìm thấy nhân viên nào
                                    </td>
                                </tr>
                                <% } %>
            </tbody>
        </table>
    </div>

    <script>
        function setLeaderRole(userId, action) {
            const msg = action === 'promote' ? 'Bổ nhiệm nhân viên này làm Tổ trưởng?' : 'Hủy chức Tổ trưởng của người này?';
            if (!confirm(msg)) return;

            fetch('/employees/set-role', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, action })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Lỗi: ' + data.message);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Lỗi kết nối server');
                });
        }
    </script>

    <%- include('../partials/footer') %>